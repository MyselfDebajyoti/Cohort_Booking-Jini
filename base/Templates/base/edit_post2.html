<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Customize Your Social Media Post</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            margin: 20px;
        }
        canvas {
            border: 2px solid black;
            margin-bottom: 20px;
            border-radius: 10px;
            cursor: grab;
        }
        textarea {
            width: 60%;
            padding: 10px;
            font-size: 16px;
        }
        button, input {
            margin: 10px;
            padding: 10px 15px;
            font-size: 16px;
            border-radius: 5px;
            cursor: pointer;
        }
        #controls {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        .btn-green {
            background-color: #28a745;
            color: white;
            border: none;
        }
        .btn-green:hover {
            background-color: #218838;
        }
    </style>
</head>
<body>

    <h1>Edit Your Social Media Post</h1>

    <!-- Canvas where AI-generated image will be displayed and edited -->
    <canvas id="canvas" width="400" height="500"></canvas>

    <div id="controls">
        <!-- Upload Logo -->
        <input type="file" id="uploadLogo" accept="image/*">
        
        <!-- Change Background Color -->
        <input type="color" id="bgColor" value="#ffffff">
        
        <!-- Add Text -->
        <input type="text" id="customText" placeholder="Enter text">
        <button class="btn-green" onclick="addText()">Add Text</button>

        <!-- Save Final Post -->
        <button class="btn-green" onclick="saveImage()">Save Post</button>
    </div>

    <form method="POST" action="{% url 'finalize_post' %}">
        {% csrf_token %}
        
        <p><strong>Product Name:</strong> {{ product_name }}</p>

        <label for="edited_caption"><strong>Edit Caption:</strong></label><br>
        <textarea name="edited_caption" rows="4">{{ caption }}</textarea><br><br>

        <label for="edited_hashtags"><strong>Edit Hashtags:</strong></label><br>
        <textarea name="edited_hashtags" rows="2">{{ hashtags }}</textarea><br><br>

        <button class="btn-green" type="submit">Finalize Post</button>
    </form>

    <script>
        const canvas = document.getElementById("canvas");
        const ctx = canvas.getContext("2d");

        // Load AI-generated image
        const imageUrl = "{{ image_url }}";
        const img = new Image();
        img.src = imageUrl;
        img.onload = () => ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

        let elements = []; // Store text & logos
        let draggingElement = null;
        let offsetX, offsetY;

        // Change Background Color
        document.getElementById("bgColor").addEventListener("input", function () {
            ctx.fillStyle = this.value;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
        });

        // Upload Logo
        document.getElementById("uploadLogo").addEventListener("change", function (event) {
            const file = event.target.files[0];
            const reader = new FileReader();
            reader.onload = function (e) {
                const logoImg = new Image();
                logoImg.src = e.target.result;
                logoImg.onload = function () {
                    elements.push({ type: "image", img: logoImg, x: 100, y: 100, width: 100, height: 100 });
                    drawCanvas();
                };
            };
            reader.readAsDataURL(file);
        });

        // Add Custom Text
        function addText() {
            const text = document.getElementById("customText").value;
            elements.push({ type: "text", text: text, x: 50, y: 50, font: "bold 20px Arial", color: "black" });
            drawCanvas();
        }

        // Draw Everything on Canvas
        function drawCanvas() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

            elements.forEach(element => {
                if (element.type === "image") {
                    ctx.drawImage(element.img, element.x, element.y, element.width, element.height);
                } else if (element.type === "text") {
                    ctx.fillStyle = element.color;
                    ctx.font = element.font;
                    ctx.fillText(element.text, element.x, element.y);
                }
            });
        }

        // Handle Dragging
        canvas.addEventListener("mousedown", function (e) {
            const rect = canvas.getBoundingClientRect();
            const mouseX = e.clientX - rect.left;
            const mouseY = e.clientY - rect.top;

            // Check if clicked on an element
            for (let i = elements.length - 1; i >= 0; i--) {
                const element = elements[i];

                if (element.type === "image") {
                    if (
                        mouseX >= element.x &&
                        mouseX <= element.x + element.width &&
                        mouseY >= element.y &&
                        mouseY <= element.y + element.height
                    ) {
                        draggingElement = element;
                        offsetX = mouseX - element.x;
                        offsetY = mouseY - element.y;
                        return;
                    }
                } else if (element.type === "text") {
                    const textWidth = ctx.measureText(element.text).width;
                    if (
                        mouseX >= element.x &&
                        mouseX <= element.x + textWidth &&
                        mouseY >= element.y - 20 &&
                        mouseY <= element.y
                    ) {
                        draggingElement = element;
                        offsetX = mouseX - element.x;
                        offsetY = mouseY - element.y;
                        return;
                    }
                }
            }
        });

        canvas.addEventListener("mousemove", function (e) {
            if (draggingElement) {
                const rect = canvas.getBoundingClientRect();
                draggingElement.x = e.clientX - rect.left - offsetX;
                draggingElement.y = e.clientY - rect.top - offsetY;
                drawCanvas();
            }
        });

        canvas.addEventListener("mouseup", function () {
            draggingElement = null;
        });

        // Save Final Image
        function saveImage() {
            const link = document.createElement("a");
            link.download = "final_post.png";
            link.href = canvas.toDataURL();
            link.click();
        }
    </script>

</body>
</html>
